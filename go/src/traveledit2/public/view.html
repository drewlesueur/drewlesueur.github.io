<!doctype html>

<canvas
   id=canvasEl
   width=3000
   height=1410
   style="width: 100%; height:",
></canvas>
<script>
var viewCounter = 0
var pullInterval = 1
var t = canvasEl.getContext("2d")
pullAndRender()
function pullAndRender() {
    fetch("/te/view?viewCounter=" + viewCounter, {
        cache: "no-cache"
    }).then(r => {
        viewCounter = r.headers.get("X-View-Counter") - 0
        console.log("viewCounter is now", viewCounter)
        return r.json()
    })
    .then(v => {
        render(v)
        setTimeout(pullAndRender, pullInterval)   
    }).catch(e => {
        alert("error viewing: " + e)
    })
}
var lastY = -99999
var fillStyleMap = {
    0: "black",
    1: "white",
    2: "brown",
    3: "yellow",
    4: "orange",
    5: "blue",
}
function fillStyleString(f) {
  if (!(f in fillStyleMap)) {
      return f
  }
  return fillStyleMap[f]
} 
var cmds = {
    0: function(a) {
        if (a.length ==1) {
            var parts = a[0].split(" ")
            for (var i=0; i<parts.length; i++) {
                var part = parts[i]
                t.fillText(part[0], part.slice(1)-0, lastY)
            }
            return
        }
        if (a.length == 2) {
            t.fillText(a[0], a[1], lastY)
            return
        }
        t.fillText(a[0], a[1], a[2])
        lastY = a[2]
    },
    1: function(a) {
        t.fillRect(a[0], a[1], a[2], a[3])
    },
    2: function(a) {
        t.fillStyle = fillStyleString(a[0])
    },
    3: function(a) {
        t.font = a[0]
    },
    4: function(a) {
        t.textBaseline = a[0]
    },
    5: function(a) {
        var fontWidth = a[0]
        var fontHeight = a[1]
        var maxCols = a[2]
        var maxLines = a[3]
        var isDark = a[4]
        // canvasEl.width = canvasEl.width
        canvasEl.width = fontWidth * maxCols  
        canvasEl.height = fontHeight * maxLines  
        t = canvasEl.getContext("2d")
        canvasEl.style.width = (canvasEl.width/2) + "px" 
        canvasEl.style.height = (canvasEl.height/2) + "px" 
        if (isDark) {
            canvasEl.style.backgroundColor = "black"
        } else {
            canvasEl.style.backgroundColor = "white"
        }
    },
}
function render(v) {
    for (var i=0; i<v.length; i++) {
        var c = v[i]
        if (typeof c === "string") {
            c = [c]
        }
        // 6 is special meaning no change
        if (c[0] === 6) {
            // pullInterval = 1000
            break    
        }
        if ((typeof c[0]) == "string") {
            cmds[0](c)
            continue
        }
        // pullInterval = 10
        cmds[c[0]](c.slice(1))
    }
}
</script>