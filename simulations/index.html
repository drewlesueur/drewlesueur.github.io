<!doctype html>
<title>Simulations</title>
<table>
<tr>
<td>
<canvas id=worldEl  width=1024 height=1024 style="width:512px; height:512px; border: 1px solid black;"></canvas>
</td>
<td>
<canvas id=graphEl width=1024 height=1024 style="width:512px; height:512px; border: 1px solid black;" style="border: 1px solid navy"></canvas>
</td>
</tr>
</table>

<script>
var populationCount = 100
var maxX = 1024
var maxY = 1024
var moveIncrement = 3
var tickDuration = 50
var chunksX = 16
var chunksY = 16
var chunkSizeX = maxX / chunksX
var chunkSizeY = maxY / chunksY

var colors = {
	"happy": "orange",
	"sad": "blue",
	"mad": "red",
	"test": "black",
}
var feelings = ["happy", "sad", "mad"]
var feelings = ["happy", "sad", "mad", "test"]

var worldCtx = document.getElementById("worldEl").getContext("2d")

var feelglips = []
for (var i=0; i < populationCount; i++) {
	feelglips.push({x: r(maxX), y: r(maxY), w: 8, h: 8, feeling: feelings[r(3)]})
}

var cachedLocations
function tick() {
	cachedLocations = {}
	for (var i=0; i<feelglips.length; i++) {
		var f = feelglips[i]
		var movement = r(4)
		if (movement == 0) {
			f.x -= moveIncrement
		} else if (movement == 1) {
			f.x += moveIncrement
		} else if (movement == 2) {
			f.y -= moveIncrement
		} else if (movement == 3) {
			f.y += moveIncrement
		}

		if (f.x < 0) {
			f.x = 0		
		} else if (f.x > maxX) {
			f.x = maxY	
		}

		if (f.y < 0) {
			f.y = 0		
		} else if (f.y > maxY) {
			f.y = maxY	
		}
		var chunkX = Math.floor(f.x / chunkSizeX)
		var chunkY = Math.floor(f.y / chunkSizeY)
		var key = chunkX + "_" + chunkY
		if (cachedLocations[key]) {
			cachedLocations[key].push(f)	
		} else {
			cachedLocations[key] = [f]
		}
	}

	// move all at once, then check overlap
	// TODO: you would need to actually check surrounding chunks
	// This is not a perfect simulation because of that
	
	// Now let's to the touching check
	for (key in cachedLocations) {
		var fs = cachedLocations[key]	
		if (!fs ||  fs.lenth == 0) {
			continue	
		}

		for (var i=0; i < fs.length;i++) {
			for (var j=i+1; j<fs.length; j++) {
				var a = fs[i]
				var b = fs[j]
				if (
					(
						(b.x >= a.x && b.x <= (a.x + a.w)) ||
						((b.x + b.w) > a.x && (b.x + b.w) < (a.x + a.w))
					) && (
						(b.y >= a.y && b.y <= (a.y + a.h)) ||
						((b.y + b.h) > a.y && (b.y + b.h) < (a.y + a.h))
					)
				) {
					a.feeling = "test"						
					b.feeling = "test"						
				}
			}	
		}
	}

	
	worldEl.width = worldEl.width // hack to clear
	render()
}

setInterval(tick, tickDuration)

function render() {
	for (var i=0; i<feelglips.length;i++) {
		var f = feelglips[i]
		worldCtx.fillStyle = colors[f.feeling]
		worldCtx.fillRect(f.x, f.y, f.w, f.h)
	}
}

function r(n) {
	return Math.floor(Math.random() * n)
}


</script>
